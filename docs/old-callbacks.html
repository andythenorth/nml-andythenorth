<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>NML documentation</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<link rel="stylesheet" title="Standard Style" type="text/css" href="nml.css">
</head>
<body>

<h1>Old-style callbacks</h1>
<p>This page contains information about the classical way of defining callbacks,
which is handling them within a chain of switch-blocks. It is not recommended to
use this method, but it is still supported for backwards compatibility,
(temporary) support for nfo->nml converted grfs and because it may be useful in
some cases. Do not use this for new NewGRFs unless you have a really good reason
to do so.</p>

<h2><a name="old-callbacks-general">General callbacks</a></h2>
<table class="t">
<tr><th>name<th>use
<tr><td>CB_RANDOM_TRIGGER <td>re-randomize random data
</table>
<p>This callback may be called for all items that have triggers associated
with them. See <a href="nml-language.html#block-randomswitch">random switch</a>
for more information.</p>

<h2><a name="old-callbacks-vehicles">Callbacks for vehicles</a></h2>
<table class="t">
<tr><th>name<th>bit to set in callback_flags property<th>available for<th>return value<th>use
<tr><td>VEH_CB_VISUAL_EFFECT_AND_POWERED <td>VEH_CBF_VISUAL_EFFECT_AND_POWERED <td>Trains <td>See property <code>visual_effect_and_powered</code> <td>decide the visual effect to use and whether a wagon has power
<tr><td>VEH_CB_VISUAL_EFFECT             <td>VEH_CBF_VISUAL_EFFECT             <td>Road Vehicles, Ships <td>See property <code>visual_effect</code> <td>decide the visual effect to use (road vehicles / ships)
<tr><td>VEH_CB_WAGON_LENGTH              <td>VEH_CBF_WAGON_LENGTH              <td>Trains, Road Vehicles <td>See train property <code>shorten_vehicle</code> <td>decide upon the length of the wagon (note: RVs have no equivalent property)
<tr><td>VEH_CB_LOAD_AMOUNT               <td>VEH_CBF_LOAD_AMOUNT               <td>All <td>See property <code>loading_speed</code><td>decide upon the loading speed (amount loaded per tick)
<tr><td>VEH_CB_REFITTED_CAPACITY         <td>VEH_CBF_REFITTED_CAPACITY         <td>All <td> Cargo capacity 0 ... 255 <td>decide upon the capacity after refit
<tr><td>VEH_CB_ARTICULATED_PARTS         <td>VEH_CBF_ARTICULATED_PARTS         <td>Trains, Road Vehicles  <td>ID of vehicle to attach, 0xFF if none<td>decide upon the ID of the next vehicle added to the articulated vehicle chain
<tr><td>VEH_CB_CARGO_SUFFIX              <td>VEH_CBF_CARGO_SUFFIX              <td>All <td> string <td>decide upon cargo subtype display for refit
<tr><td>VEH_CB_CAN_ATTACH_WAGON          <td>None                              <td>Trains <td> string containing error message, or one of the following:
0xFD (disallow with message "incomatible railtypes"), 0xFE (allow) or 0xFF (allow if railtypes match) <td>decide whether a wagon can be attached
<tr><td>VEH_CB_TEXT_PURCHASE_SCREEN      <td>None                              <td>All <td>string <td>decide upon an additional text for the purchase screen
<tr><td>VEH_CB_COLOUR_MAPPING            <td>VEH_CBF_COLOUR_MAPPING            <td>All <td>sprite number <td>decide upon the colour mapping instead of company colour
<tr><td>VEH_CB_START_STOP_CHECK          <td>None                              <td>All <td>string containing error message, or 0xFF to allow <td>decide whether a vehicle may be started/stopped.
<tr><td>VEH_CB_32DAY                     <td>None                              <td>All <td>bitmask <td>Triggers one or both of <it>Trigger vehicle trigger 10</it> (bit 0) and <it>Update colour map via VEH_CB_COLOUR_MAPPING</it> (bit 1)
<tr><td>VEH_CB_SOUND_EFFECT              <td>None                              <td>All <td>sound effect number <td>decide whether and which sound is being played for certain situations
<tr><td>VEH_CB_AUTOREPLACE_SELECT        <td>None                              <td>All <td>vehicle ID <td> decide upon appropriate replacement vehicles (not implemented in OpenTTD)
<tr><td>VEH_CB_VEHICLE_PROPERTIES        <td>None                              <td>All <td>property-dependent <td>Change vehicle properties, see below
</table>
<p>In order to set properties for vehicles via callback <code>VEH_CB_VEHICLE_PROPERTIES</code> it's necessary to query the general variable <code>extra_callback_info1</code>
which can take different values depending upon the vehicle type:</p>
<table class="t">
<tr><th>property<th>available for<th>value
<tr><td>cost_factor<td>all<td>PROP_XXX_COST_FACTOR
<tr><td>running_cost_factor<td>all<td>PROP_XXX_RUNNING_COST_FACTOR
<tr><td>speed<td>all<td>PROP_XXX_SPEED
<tr><td>power<td>trains and road vehicles<td>PROP_XXX_POWER
<tr><td>weight<td>trains and road vehicles<td>PROP_XXX_WEIGHT
<tr><td>tractive_effort_coefficient<td>trains and road vehicles<td>PROP_XXX_TRACTIVE_EFFORT_COEFFICIENT
<tr><td>cargo_capacity<td>all except aircraft<td>PROP_XXX_CARGO_CAPACITY
<tr><td>passenger_capacity<td>aircraft<td>PROP_AIRCRAFT_PASSENGER_CAPACITY
<tr><td>mail_capacity<td>aircraft<td>PROP_AIRCRAFT_MAIL_CAPACITY
<tr><td>bitmask_vehicle_info<td>trains<td>PROP_TRAINS_BITMASK_VEHICLE_INFO
</table>
<p>Where for the properties available for all vehicle types XXX can either be TRAINS, ROADVEHS, SHIPS or AIRCRAFT.
Note also that the return values don't yet support units, you'll need to enter the properties untranslated (e.g. road vehicle
weights are in quantities of 0.25 tons).</p><p>The following code is an example for the use of callbacks and most notably also
the creation of articulated vehicles which can only be created by means of the VEH_CB_ARTICULATED_PARTS:</p>
<pre class="code">
/* Here would have to be definition of sprite sets and groups */

/* callback for articulated vehicles: 4 wagons with special sprites for first and last */
switch(FEAT_TRAINS, SELF, rail_engine_articulated_parts, extra_callback_info1) {
    1..2: return rail_wagon; // middle parts use rail wagons
	3: return rail_engine;   // last part is this rail engine again
    CB_FAILED;               // no more than 4 vehicles
}

/* Set the (empty) weight of the vehicle depending on the cargo it carries */
switch (FEAT_TRAINS, SELF, rail_wagon_cb_property_weight_switch, cargo_type_in_veh) {
    PASS: return 30; // Passenger wagons are heavier
    TOUR: return 30; // Tourists are also passengers
    CB_FAILED;       // use value set in the property block for other cargos
}

/* Set (conditionally) different properties of the train */
switch (FEAT_TRAINS, SELF, rail_engine_cb_property_switch, extra_callback_info1) {
    PROP_TRAINS_WEIGHT          : rail_engine_cb_property_weight_switch;
    PROP_TRAINS_CARGO_CAPACITY  : rail_engine_cb_capacity_switch; // not shown here
    CB_FAILED;                                                    // we don't set other properties
}

/* Check for each (active) callback */
switch (FEAT_TRAINS, SELF, rail_engine_switch, current_callback) {
    VEH_CB_REFITTED_CAPACITY:  rail_engine_cb_capacity_switch; // switch not shown here
    VEH_CB_VEHICLE_PROPERTIES: rail_engine_cb_property_switch;
    VEH_CB_ARTICULATED_PARTS: rail_engine_articulated_parts;
    rail_engine_graphics_switch; // go to graphics branch, if no callback asked for; not shown here
}

/* Define this rail engine */
item(FEAT_TRAINS, rail_engine) {
    property {
        callback_flags:                 bitmask(VEH_CBF_ARTICULATED_PARTS, VEH_CBF_REFITTED_CAPACITY); // activate callbacks
        cargo_capacity:                 20;
        weight:                         24 ton;
    }
    graphics {
        rail_engine_switch;
    }
}
</pre>

<h2><a name="old-callbacks-industrytiles">Industry Tile Callbacks</a></h2>
<table class="t">
<tr><th>Callback</th><th>Values<th>Meaning</th></tr>
<tr><td>INDTILE_CB_ANIM_STARTSTOP</td><td>animation frame or CB_RESULT_XXX<td>Called by a trigger. It decides upon the next animation frame.
Special values: XXX=[STOP_ANIMATION | NEXT_FRAME | DO_NOTHING]</td></tr>
<tr><td>INDTILE_CB_ANIM_NEXT_FRAME</td><td>animation frame or CB_RESULT_XXX<td>Called each animation frame. It decides upon the next animation frame.
Special values: XXX=[STOP_ANIMATION | NEXT_FRAME]</td></tr>
<tr><td>INDTILE_CB_ANIM_SPEED</td><td>length<td>Length of the animation frame as defined in the apendix. This is a very expensive callback and try to
avoid it, if possible, by using identical animation frames.</td></tr>
<tr><td>INDTILE_CB_CARGO_AMOUNT_ACCEPT</td><td>special<td>accepted cargo amounts in 1/8. Bits 0...3: 1st cargo, bits 4 ... 7: 2nd cargo, bits 8 ... 11: 3rd cargo</td></tr>
<tr><td>INDTILE_CB_CARGO_TYPE_ACCEPT</td><td>special<td>accepted cargo types as entry in the CTT. Bits 0...4: 1st cargo, bits 5 ... 9: 2nd cargo, bits 10 ... 14: 3rd cargo</td></tr>
<tr><td>INDTILE_CB_SLOPE_IS_SUITABLE</td><td><td>decide whether the location is suitable for the tile (for build checks of the industry)</td></tr>
<tr><td>INDTILE_CB_FOUNDATIONS</td><td>CB_RESULT_XXX<td>with XXX=[FOUNDATIONS | NO_FOUNDATIONS]</td></tr>
<tr><td>INDTILE_CB_AUTOSLOPE</td><td>CB_RESULT_XXX<td>with XXX=[AUTOSLOPE | NO_AUTOSLOPE]</td></tr>
</table>

<h2><a name="old-callbacks-industries">Industry callback flags</a></h2>
<table class="t">
<tr><th>callback and callback flag<br>
IND_CB_XXX and IND_CBF_XXX</th><th>return values</th><th>meaning</tr>
<tr><td>IND_CBF_AVAILABILITY</td><td>CB_RESULT_IND_ALLOW<br>CB_RESULT_IND_DISALLOW</td><td>decide upon availability of the industry type.<br>
extra_callback_info_2 allows to get information on how the industry is being built:<br>
0: during map generation<br>1: random generation ingame<br>2: user trying to fund or prospect the industry</td></tr>
<tr><td>IND_CBF_PROD_CB_CARGO_ARRIVE<br>(no callback, use <a href="nml-language.html#block-produce">produce block</a>)</td><td>n/a (use produce block)</td>
        <td>handle production when cargo is delivered. See produce block</td></tr>
<tr><td>IND_CBF_PROD_CB_256_TICKS<br>(no callback, use <a href="nml-language.html#block-produce">produce block</a>)</td><td>n/a (use produce block)</td>
        <td>handle production every 256 ticks. See produce block</td></tr>
<tr><td>IND_CBF_LOCATION_CHECK</td><td>string<br>
CB_RESULT_IND_ALLOW_LOCATION<br>
CB_RESULT_IND_DISALLOW_UNSUITABLE<br>
CB_RESULT_IND_DISALLOW_ONLY_RAINFOREST<br>
CB_RESULT_IND_DISALLOW_ONLY_DESERT</td><td>handle check for permissible build locations<br>
extra_callback_info_2 allows to get information on how the industry is being built:<br>
0: during map generation<br>1: random generation ingame<br>2: user trying to fund the industry<br>
3: user trying to prospect the industry</td></tr>
<tr><td>IND_CBF_RANDOM_PROD_CHANGE</td><td>see monthly production changes below</td><td>handle random production changes</td></tr>
<tr><td>IND_CBF_MONTHLY_PROD_CHANGE</td><td>CB_RESULT_IND_PROD_NO_CHANGE<br>
CB_RESULT_IND_PROD_HALF<br>
CB_RESULT_IND_PROD_DOUBLE<br>
CB_RESULT_IND_PROD_CLOSE<br>
CB_RESULT_IND_PROD_RANDOM<br>
CB_RESULT_IND_PROD_DIVIDE_BY_4<br>
CB_RESULT_IND_PROD_DIVIDE_BY_8<br>
CB_RESULT_IND_PROD_DIVIDE_BY_16<br>
CB_RESULT_IND_PROD_DIVIDE_BY_32<br>
CB_RESULT_IND_PROD_MULTIPLY_BY_4<br>
CB_RESULT_IND_PROD_MULTIPLY_BY_8<br>
CB_RESULT_IND_PROD_MULTIPLY_BY_16<br>
CB_RESULT_IND_PROD_MULTIPLY_BY_32<br>
CB_RESULT_IND_PROD_DECREMENT_BY_1<br>
CB_RESULT_IND_PROD_INCREMENT_BY_1<br>
CB_RESULT_IND_PROD_SET_BY_0x100<br>
</td><td>handle monthly production changes</td></tr>
<tr><td>IND_CBF_CARGO_SUBTYPE_DISPLAY</td><td>string</td><td>decide on displayed cargo subtypes</td></tr>
<tr><td>IND_CBF_EXTRA_TEXT_FUND</td><td>string</td><td>decide on extra text displayed in industry funding window</td></tr>
<tr><td>IND_CBF_EXTRA_TEXT_INDUSTRY</td><td>string</td><td>decide on extra text in the industry window</td></tr>
<tr><td>IND_CBF_CONTROL_SPECIAL</td><td>CB_RESULT_IND_DO_NOT_USE_SPECIAL<br>CB_RESULT_IND_USE_SPECIAL</td><td>decide whether the special defined in spec_flags shall be used or not</td></tr>
<tr><td>IND_CBF_STOP_ACCEPT_CARGO</td><td></td><td>decide on cargo acceptance</td></tr>
<tr><td>IND_CBF_COLOUR</td><td>0...15</td><td>decide on industry colour. See also <a href="refs.html#refs-palettes">the palettes</a>. DARK_BLUE (#775) corresponds to the colour 0.</td></tr>
<tr><td>IND_CBF_CARGO_INPUT</td><td>cargo label</td><td>decide on accepted cargo types. extra_callback_info_1 gives the input cargo number.
Return 0xFF for any other value than 0, 1 or 2 for extra_callback_info_1.</td></tr>
<tr><td>IND_CBF_CARGO_OUTPUT</td><td>cargo label</td><td>decide on output cargo types. extra_callback_info_1 gives the output cargo number.
Return 0xFF for any other value than 0 or 1 for extra_callback_info_1.</td></tr>
</table>

<h2><a name="old-callbacks-cargos">Cargo callbacks</a></h2>
<table class="t">
<tr><th>value</th><th>description</th></tr>
<tr><td>CARGO_CB_PROFIT</td>        <td>Custom profit calculation</td></tr>
<tr><td>CARGO_CB_STATION_RATING</td><td>Custom station rating calculation</td></tr>
</table>

<h2><a name="old-callbacks-objects">Object callbacks</a></h2>
<table class="t">
<tr><th>Name</th><th>Meaning</th></tr>
<tr><td>OBJ_CB_SLOPE_CHECK</td><td>Check for the slope of a tile
<tr><td>OBJ_CB_DECIDE_ANIM</td><td>Decide whether animation continues: 0xFF stops animation, 0xFE continues with next frame
<tr><td>OBJ_CB_DECIDE_ANIM_SPEED</td><td>Decide the animation frame to jump to. Or alternatively: 0xFF to stop animation, 0xFE
to start animation with current frame, 0xFD to keep the current animation frame and do nothing
<tr><td>OBJ_CB_DECIDE_COLOUR</td><td>Return the colour, or for 2 company colours the two colours, to be used. In the case of 2CC the 2nd company colour
goes into the high 4 bits of the return value
<tr><td>OBJ_CB_ADDITIONAL_TEXT</td><td>Return an additional string which is shown in the purchase menu. It should not exceed in length three lines.
<tr><td>OBJ_CB_AUTOSLOPE</td><td>Return a value different from 0 in order to disable autoslope behaviour.
</table>

</body>
</html>
